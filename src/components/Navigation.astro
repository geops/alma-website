---
import AlmaLogo from "../components/AlmaLogo.svg";
import ChevronIcon from "../components/icons/ChevronIcon.svg";
import CloseIcon from "../components/icons/CloseIcon.svg";
import MenuIcon from "../components/icons/MenuIcon.svg";
import { tw, useTranslations } from "../lib.ts";

const t = useTranslations(Astro.currentLocale);

function getLinkClass(active?: boolean) {
  return tw`w-fit rounded-full px-4 py-2 font-medium whitespace-nowrap ${active ? "bg-gray-2" : ""}`;
}
---

<!-- desktop navigation -->
<nav
  class="fixed top-8 left-1/2 z-20 hidden -translate-x-1/2 items-start space-x-5 md:flex"
>
  <div
    class="flex items-center rounded-4xl bg-white/70 p-2.5 pl-5 shadow-lg backdrop-blur"
  >
    <a href="#top"><AlmaLogo /></a>
    <div class="border-gray-3 ml-4 flex space-x-2.5 border-l pl-4">
      <a class={getLinkClass(true)} href="#about">{t("navigation.about")}</a>
      <a class={getLinkClass()} href="#features">{t("navigation.features")}</a>
      <a class={getLinkClass()} href="#community">{t("navigation.community")}</a
      >
      <a class={getLinkClass()} href="#contact">{t("navigation.contact")}</a>
    </div>
  </div>
  <div
    class="relative rounded-4xl bg-white/70 p-2.5 pr-5 shadow-lg backdrop-blur"
  >
    <input id="langstate" type="checkbox" class="peer hidden" />
    <div class="min-w-14 px-4 py-2 font-medium">
      {Astro.currentLocale?.toUpperCase()}
    </div>
    <label
      for="langstate"
      class="absolute top-5 right-2 cursor-pointer pl-8 peer-checked:rotate-180 peer-checked:pr-8 peer-checked:pl-0"
    >
      <ChevronIcon />
    </label>
    <div class="col-span-2 mt-2 hidden flex-col space-y-2 peer-checked:flex">
      <a class={getLinkClass(Astro.currentLocale === "de")} href="/de">DE</a>
      <a class={getLinkClass(Astro.currentLocale === "fr")} href="/fr">FR</a>
      <a class={getLinkClass(Astro.currentLocale === "it")} href="/it">IT</a>
    </div>
  </div>
</nav>

<!-- mobile navigation -->
<nav
  class="fixed top-8 right-4 left-4 z-20 rounded-4xl bg-white px-5 py-4 shadow md:hidden"
>
  <input id="menustate" type="checkbox" class="peer hidden" />
  <a href="#top"><AlmaLogo class="peer-checked:hidden" /></a>
  <label
    class="absolute top-4 right-5 block p-1 peer-checked:hidden"
    for="menustate"
  >
    <MenuIcon />
  </label>
  <label
    for="menustate"
    class="absolute top-4 right-5 hidden p-1 peer-checked:block"
  >
    <CloseIcon />
  </label>
  <div class="mt-6 hidden flex-col space-y-4 peer-checked:flex">
    <a class={getLinkClass(true)} href="#about">{t("navigation.about")}</a>
    <a class={getLinkClass()} href="#features">{t("navigation.features")}</a>
    <a class={getLinkClass()} href="#community">{t("navigation.community")}</a>
    <a class={getLinkClass()} href="#contact">{t("navigation.contact")}</a>
  </div>
  <div
    class="border-gray-3 mt-4 hidden flex-col space-y-4 border-t pt-4 peer-checked:flex"
  >
    <a class={getLinkClass(Astro.currentLocale === "de")} href="/de">DE</a>
    <a class={getLinkClass(Astro.currentLocale === "fr")} href="/fr">FR</a>
    <a class={getLinkClass(Astro.currentLocale === "it")} href="/it">IT</a>
  </div>
</nav>

<script>
  const navLinks = document.querySelectorAll('nav a[href^="#"]');
  const menuCheckbox = document.getElementById("menustate") as HTMLInputElement;

  // Close mobile menu when clicking on anchor links
  navLinks.forEach((link) => {
    link.addEventListener("click", () => {
      if (menuCheckbox) {
        menuCheckbox.checked = false;
      }
    });
  });

  function setActiveLink(sectionId: string) {
    navLinks.forEach((link) => {
      const href = link.getAttribute("href");
      const linkSection = href?.slice(1);
      if (linkSection === sectionId) {
        link.classList.add("bg-gray-2");
      } else {
        link.classList.remove("bg-gray-2");
      }
    });
  }

  const observerCallback = (entries: IntersectionObserverEntry[]) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        const sectionId = entry.target.id;
        setActiveLink(sectionId);
      }
    });
  };

  const observer = new IntersectionObserver(observerCallback, {
    rootMargin: "-50% 0px -50% 0px", // Trigger when section crosses the middle of viewport
    threshold: 0,
  });

  // Observe all sections with IDs that match navigation links
  navLinks.forEach((link) => {
    const href = link.getAttribute("href");
    const sectionId = href?.slice(1);
    if (sectionId) {
      const section = document.getElementById(sectionId);
      if (section) {
        observer.observe(section);
      }
    }
  });
</script>
